import{i as V,j as D,_ as U,D as F,m as I,k as L}from"./Cv5foL5a.js";import{E as G}from"./BeFyUl0g.js";import{d as H,r as n,c as q,w as k,o as J,a as o,g as x,f as s,b as w,m as K,h as O,F as C,n as N,t as v,e as l,i as P,p as A,G as M}from"./DW3SVq1p.js";const Q={class:"min-h-screen bg-slate-50 dark:bg-slate-900"},W={class:"max-w-3xl mx-auto px-4 py-6"},X={class:"rounded-xl bg-white dark:bg-slate-800 p-4 shadow mb-4"},Y={class:"flex items-center justify-between mb-4"},Z={key:0,class:"space-y-3"},ee={key:1,class:"text-center py-12"},se={key:2,class:"space-y-2"},te=["onClick"],ae={class:"flex-shrink-0 mt-1"},le={class:"flex-1 min-w-0"},oe={class:"text-sm text-slate-600 dark:text-slate-300"},re={class:"text-xs text-slate-400 dark:text-slate-500 mt-1"},ne={key:3,class:"mt-4 flex justify-center"},de=["disabled"],f=20,ve=H({__name:"index",setup(ie){const r=n([]),d=n(!0),i=n(!1),c=n(!1),u=n(null),m=n(!1),{data:$,pending:j}=V({take:f}),{data:B,refresh:h}=D(),R=q(()=>B.value?.count||0);k($,e=>{e?.items&&(r.value=e.items,m.value=e.items.length===f,e.items.length>0&&(u.value=e.items[e.items.length-1].id),d.value=!1)},{immediate:!0}),k(j,e=>{!e&&d.value&&(d.value=!1)}),J(async()=>{await h()});async function T(){if(!(i.value||!u.value)){i.value=!0;try{const e=await $fetch(`/api/notifications?take=${f}&cursor=${encodeURIComponent(u.value)}`);e.items.length>0?(r.value=r.value.concat(e.items),m.value=e.items.length===f,u.value=e.items[e.items.length-1].id):m.value=!1}catch(e){console.error("加载更多通知失败:",e)}finally{i.value=!1}}}async function z(e){if(!e.read)try{await I(e.id),e.read=!0,await h()}catch(a){console.error("标记通知为已读失败:",a)}e.type==="daily_posted"||e.type==="daily_comment"||e.type==="daily_comment_reply"?e.relatedId&&M("/daily"):(e.type==="message_posted"||e.type==="message_comment"||e.type==="message_comment_reply")&&M("/messages")}async function E(){c.value=!0;try{await L(),r.value.forEach(e=>{e.read=!0}),await h()}catch(e){console.error("全部标记为已读失败:",e)}finally{c.value=!1}}function S(e){const a=new Date(e),t=new Date().getTime()-a.getTime(),_=Math.floor(t/1e3),g=Math.floor(_/60),p=Math.floor(g/60),b=Math.floor(p/24);return _<60?"刚刚":g<60?`${g}分钟前`:p<24?`${p}小时前`:b<7?`${b}天前`:a.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}return(e,a)=>{const y=U;return l(),o("div",Q,[x(F),s("div",W,[s("div",X,[s("div",Y,[a[0]||(a[0]=s("h1",{class:"text-xl font-semibold"},"通知",-1)),R.value>0?(l(),K(y,{key:0,size:"sm",class:"bg-amber-600 hover:bg-amber-700 text-white",onClick:E,disabled:c.value},{default:O(()=>[P(v(c.value?"处理中...":"全部标记为已读"),1)]),_:1},8,["disabled"])):w("",!0)]),d.value?(l(),o("div",Z,[(l(),o(C,null,N(5,t=>s("div",{key:t,class:"animate-pulse"},[...a[1]||(a[1]=[s("div",{class:"h-16 bg-slate-200 dark:bg-slate-700 rounded"},null,-1)])])),64))])):r.value.length===0?(l(),o("div",ee,[x(G,{text:"暂无通知",img:"/assets/images/xiaojimao/xiaojimao-4.png"})])):(l(),o("div",se,[(l(!0),o(C,null,N(r.value,t=>(l(),o("div",{key:t.id,class:A(["flex items-start gap-3 p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition cursor-pointer",{"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":!t.read}]),onClick:_=>z(t)},[s("div",ae,[s("div",{class:A(["w-2 h-2 rounded-full",t.read?"bg-transparent":"bg-red-600"])},null,2)]),s("div",le,[s("div",oe,v(t.content),1),s("div",re,v(S(t.createdAt)),1)])],10,te))),128))])),m.value&&!d.value?(l(),o("div",ne,[s("button",{class:"btn-secondary",onClick:T,disabled:i.value},v(i.value?"加载中…":"加载更多"),9,de)])):w("",!0)])])])}}});export{ve as default};
